name: CI
on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:
jobs:
    docs:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2

            - name: Generating Docs.
              id: reading-file
              uses: Pika1998/express-autodocs@v0.0.2
              with:
                  server-filepath: backend/index.js
                  outputFormat: markdown
                  docsTitle: covid-tracker-email documentation

    test:
        timeout-minutes: 20
        runs-on: ubuntu-latest
        # services:
        #     postgres:
        #         image: postgres
        #         env:
        #             POSTGRES_PASSWORD: ${{ secrets.postgres_password }}
        #         options: >-
        #             --health-cmd pg_isready
        #             --health-interval 10s
        #             --health-timeout 5s
        #             --health-retries 5
        #         ports:
        #             - 5432:5432
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: 16
            - name: Install frontend dependencies
              working-directory: ./frontend
              run: yarn
            - name: Install backend dependencies
              working-directory: ./backend
              run: yarn
            - name: Install postgres
              working-directory: ./backend
              run: |
                  sudo apt install postgresql postgresql-contrib -y
                  apt show postgresql
                  sudo systemctl restart postgresql.service
            - name: Initialise database phase 1
              working-directory: ./backend
              run: psql -f sql_setup_1.sql
            - name: Initialise database phase 2
              working-directory: ./backend
              run: psql -U covid-tracker-user -h 127.0.0.1 covid-tracker-email -f sql_setup_2.sql
            - name: Install Playwright Browsers
              working-directory: ./frontend
              run: yarn playwright install --with-deps
            - name: Run Playwright tests
              working-directory: ./frontend
              run: yarn playwright test
